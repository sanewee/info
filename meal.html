<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Meal</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #ffffff00;
      padding: 20px;
      font-size: clamp(12px, 1.2vw, 18px); /* 반응형 글꼴 크기 */
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: #ffffff;
      margin-top: 0px;
      table-layout: fixed; /* 칼럼 균등 분배 */
    }
    th, td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
      vertical-align: top;
      word-wrap: break-word;
    }
    th:first-child,
    td:first-child {
      width: 2em; /* '구분' 열 고정 */
    }
    th {
      background-color: #eee;
    }
  </style>
  
</head>
<body>
  <table id="mealTable">
    <thead>
      <tr id="dateRow"><th>구분</th></tr>
    </thead>
    <tbody>
      <tr id="lunchRow"><th>중식</th></tr>
      <tr id="dinnerRow"><th>석식</th></tr>
    </tbody>
  </table>

  <script>
    const key = '31f145ae8c4a464a9c490aec5ddcc208';
    const eduOfficeCode = 'I10';
    const schoolCode = '9300117';

    const today = new Date();
    const day = today.getDay(); // 0(일) ~ 6(토)
    const monday = new Date(today);

    if (day === 0) {
      // 일요일이면 다음 주 월요일
      monday.setDate(today.getDate() + 1);
    } else if (day === 6) {
      // 토요일이면 다음 주 월요일
      monday.setDate(today.getDate() + 2);
    } else {
      // 평일이면 이번 주 월요일
      monday.setDate(today.getDate() - (day - 1));
    }

    const dates = [];
    for (let i = 0; i < 5; i++) {
      const d = new Date(monday);
      d.setDate(monday.getDate() + i);
      dates.push(d);
    }

    const formatDate = d => d.toISOString().slice(0, 10).replace(/-/g, '');

    const fromYMD = formatDate(dates[0]);
    const toYMD = formatDate(dates[4]);

    const apiUrl = `https://meal-api.mikhaila1477.workers.dev/?from=${fromYMD}&to=${toYMD}`;

    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        const entries = data?.mealServiceDietInfo?.[1]?.row || [];

        // 날짜 헤더 구성
        const dateRow = document.getElementById('dateRow');
        const lunchRow = document.getElementById('lunchRow');
        const dinnerRow = document.getElementById('dinnerRow');

        dates.forEach(date => {
          const ymd = formatDate(date);
          const label = `${date.getDate()}`;
          dateRow.innerHTML += `<th>${label}</th>`;

          // 중식 찾기
          const lunch = entries.find(e => e.MLSV_YMD === ymd && e.MMEAL_SC_NM === '중식');
          const lunchText = lunch ? lunch.DDISH_NM.replace(/\([^\)]*\)/g, '').replace(/<br\/?>/g, '<br>') : '-';
          lunchRow.innerHTML += `<td>${lunchText}</td>`;

          // 석식 찾기
          const dinner = entries.find(e => e.MLSV_YMD === ymd && e.MMEAL_SC_NM === '석식');
          const dinnerText = dinner ? dinner.DDISH_NM.replace(/\([^\)]*\)/g, '').replace(/<br\/?>/g, '<br>') : '-';
          dinnerRow.innerHTML += `<td>${dinnerText}</td>`;
        });
      })
      .catch(err => {
        document.getElementById('mealTable').innerHTML = `<tr><td colspan="6">데이터를 불러오는 데 실패했습니다.</td></tr>`;
        console.error(err);
      });
  </script>
</body>
</html>
